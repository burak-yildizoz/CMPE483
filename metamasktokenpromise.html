<!DOCTYPE html>
<html lang="en">
<head>
    <title>Browser Transactions</title>
    <script src="erc20tokenabi.js?2"> </script>
    <script src="bulottokenabi.js?2"> </script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    <script>
        window.addEventListener('load', async () => {
            // Modern dapp browsers...
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                try {
                    // Request account access if needed
                    await ethereum.enable();
                } catch (error) {
                    alert("Cannot access user ethereum account");
                }
            }
            // Legacy dapp browsers...
            else if (window.web3) {
                window.web3 = new Web3(web3.currentProvider);
            }
            // Non-dapp browsers...
            else {
                alert('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }
        });

        function mark_text(text) {
            return "<mark>" + text + "</mark>";
        }

        function getERC20TokenAddr() {
            var contaddr = "0x0";
            var contaddrlist = document.getElementsByName("token");
            for (var i=0, size=contaddrlist.length; i<size; i++) {
                if(contaddrlist[i].checked) {
                    contaddr = contaddrlist[i].value;
                }
            }
            return contaddr;
        }

        function getBULOTAddr() {
            return "0x80078e8f6f2DEc1B80f2F4cf940acCcCCb6Fa8AF";  // KAYYUMCOIN, period: 5 minutes
        }

        function getTokenBalance() {
            var ERC20contract = new web3.eth.Contract(erc20tokenabi, getERC20TokenAddr());
            var fromaddr = document.getElementById("text_owner").value;
            var mypromise = ERC20contract.methods.balanceOf(fromaddr).call();
            mypromise.then(
                function(result) {
                    document.getElementById("status_getTokenBalance").innerHTML = "Balance:" + mark_text(result);
                },
                function(err) {
                    console.log(err);
                }
            );
        }

        var lotteryNo = 0;
        function getCurrentLotteryNo() {
            var BULOTcontract = new web3.eth.Contract(bulottokenabi, getBULOTAddr());
            var mypromise = BULOTcontract.methods.getCurrentLotteryNo().call();
            mypromise.then(
                function(result) {
                    document.getElementById("status_getCurrentLotteryNo").innerHTML = "Current Lottery No: " + mark_text(result);
                    lotteryNo = result;
                },
                function(err) {
                    console.log(err);
                }
            );
            return mypromise;
        }

        async function test() {
            await getCurrentLotteryNo();
            document.getElementById("status_test").innerHTML = "Test: " + mark_text(lotteryNo);
        }

        var hashResult;
        function hash(text) {
            var BULOTcontract = new web3.eth.Contract(bulottokenabi, getBULOTAddr());
            var mypromise = BULOTcontract.methods.getHash(text).call();
            mypromise.then(
                function(result) {
                    hashResult = result;
                },
                function(err) {
                    console.log(err);
                }
            );
            return mypromise;
        }

        async function displayHash() {
            var text = document.getElementById("text_hash").value;
            await hash(text);
            document.getElementById("status_displayHash").innerHTML = "Hash of " + text + ": " + mark_text(hashResult);
        }

        var lastBoughtTicketNo;
        async function getLastBoughtTicketNo() {
            await getCurrentLotteryNo();
            var BULOTcontract = new web3.eth.Contract(bulottokenabi, getBULOTAddr());
            var mypromise = BULOTcontract.methods.getLastBoughtTicketNo(lotteryNo).call();
            mypromise.then(
                function(result) {
                    lastBoughtTicketNo = result;
                },
                function(err) {
                    console.log(err);
                }
            );
            return mypromise;
        }

        var ticketPrice;
        function getTicketPrice() {
            var BULOTcontract = new web3.eth.Contract(bulottokenabi, getBULOTAddr());
            var mypromise = BULOTcontract.methods.getTicketPrice().call();
            mypromise.then(
                function(result) {
                    ticketPrice = result;
                },
                function(err) {
                    console.log(err);
                }
            );
            return mypromise;
        }

        async function buyTicket() {
            var hash = document.getElementById("text_ticket").value;
            var fromaddr = document.getElementById("text_owner").value;
            var BULOTaddr = getBULOTAddr();
            var ERC20contract = new web3.eth.Contract(erc20tokenabi, getERC20TokenAddr());
            var BULOTcontract = new web3.eth.Contract(bulottokenabi, BULOTaddr);
            await getTicketPrice();
            await ERC20contract.methods.approve(BULOTaddr, ticketPrice).call({from:fromaddr});
            var mypromise = BULOTcontract.methods.buyTicket(hash).send({from:fromaddr});
            await getLastBoughtTicketNo();
            mypromise.then(
                function(result) {
                    document.getElementById("status_buyTicket").innerHTML = "Bought ticket: " + mark_text(lastBoughtTicketNo) + " (lottery number: " + mark_text(lotteryNo) + ")";
                },
                function(err) {
                    console.log(err);
                }
            );
        }

    </script>
</head>

<body>
    <h1>Check Your Balances</h1>
    <form>
        <p> Owner Address: <textarea id="text_owner" rows="1" cols="44" style="overflow:auto;resize:none"
          placeholder="0x0123456789ABCDEF0123456789abcdef01234567"></textarea> </p>
        <p> Token:<br>
            <input type="radio" id="token1" name="token" value=0x03207A15dE9B5A4d2BA11B2aa60Dc6272eA0b5BE>
                <label for="token1" checked>BUCOIN</label><br>
            <input type="radio" id="token2" name="token" value=0x12c25Bd781709166Fd24784eE7C03bFB93480699>
                <label for="token2">Turkish Lira</label><br>
            <input type="radio" id="token3" name="token" value=0x9F2faBAC1274C2C0FaFE403C6F19ea019f70D908>
                <label for="token3">KAYYUMCOIN</label><br>
        </p>
    </form>
    <button onclick="getTokenBalance()">Get Token Balance</button>
    <p id="status_getTokenBalance"></p>

    <p> Hash of your ticket: <textarea id="text_ticket" rows="1" cols="70" style="overflow:auto;resize:none"></textarea> </p>
    <button onclick="buyTicket()">Buy Ticket</button>
    <p id="status_buyTicket"></p>

    <button onclick="test()">Test</button>
    <p id="status_test"></p>

    <button onclick="getCurrentLotteryNo()">Get Current Week</button>
    <p id="status_getCurrentLotteryNo"></p>

    <p> Number to be hashed: <textarea id="text_hash" rows="1" cols="70" style="overflow:auto;resize:none"
      placeholder="0"></textarea> </p>
    <button onclick="displayHash()">Hash!</button>
    <p id="status_displayHash"></p>
</body>
</html>
